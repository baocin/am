package main

import (
	"context"
	"encoding/json"
	"log"
	"os"

	"github.com/nats-io/nats.go"
	"go.opentelemetry.io/otel"
	"go.opentelemetry.io/otel/trace"
)

var tracer = otel.Tracer("eeg-processor")

func main() {
	nc, err := nats.Connect("nats://loom-nats:4222")
	if err != nil {
		log.Fatal("Failed to connect to NATS:", err)
	}
	defer nc.Close()

	useGPU := os.Getenv("USE_GPU") == "true"
	log.Printf("GPU enabled: %v", useGPU)

	_, err = nc.Subscribe("user.*.eeg.stored", handleEEGProcessing(nc, useGPU))
	if err != nil {
		log.Fatal("Failed to subscribe to eeg.stored:", err)
	}

	select {}
}

func handleEEGProcessing(nc *nats.Conn, useGPU bool) nats.MsgHandler {
	return func(msg *nats.Msg) {
		ctx, span := tracer.Start(context.Background(), "handleEEGProcessing")
		defer span.End()

		var payload struct {
			DeviceID  string    `json:"device_id"`
			Timestamp string    `json:"timestamp"`
			Samples   []float64 `json:"samples"`
			Frequency int       `json:"frequency"`
			TraceID   string    `json:"trace_id"`
		}

		if err := json.Unmarshal(msg.Data, &payload); err != nil {
			log.Println("Failed to unmarshal payload:", err)
			return
		}

		features := processEEGWithGPU(payload.Samples, payload.Frequency, useGPU)

		result := map[string]interface{}{
			"device_id":  payload.DeviceID,
			"timestamp":  payload.Timestamp,
			"features":   features,
			"trace_id":   payload.TraceID,
		}
		data, _ := json.Marshal(result)
		subject := "user." + payload.DeviceID + ".eeg.processed"
		if err := nc.Publish(subject, data); err != nil {
			log.Println("Failed to publish features:", err)
		}
	}
}

func processEEGWithGPU(samples []float64, frequency int, useGPU bool) []float64 {
	if useGPU {
		log.Println("Processing EEG with GPU")
		return samples
	}
	log.Println("Processing EEG with CPU")
	return samples
}