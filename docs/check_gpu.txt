#!/bin/bash

if command -v nvidia-smi >/dev/null 2>&1; then
    echo "NVIDIA GPU detected"
    if ! command -v nvidia-ctk >/dev/null 2>&1; then
        echo "Installing NVIDIA Container Toolkit..."
        distribution=$(. /etc/os-release;echo $ID$VERSION_ID)
        curl -fsSL https://nvidia.github.io/nvidia-docker/gpgkey | sudo apt-key add -
        curl -s -L https://nvidia.github.io/nvidia-docker/$distribution/nvidia-docker.list | sudo tee /etc/apt/sources.list.d/nvidia-docker.list
        sudo apt-get update
        sudo apt-get install -y nvidia-container-toolkit
        sudo nvidia-ctk runtime configure --runtime=containerd
        sudo systemctl restart containerd
    fi
    kubectl label node $(hostname) nvidia.com/gpu=true --overwrite
    echo "GPU support enabled"
    exit 0
else
    echo "No NVIDIA GPU detected, falling back to CPU"
    kubectl label node $(hostname) nvidia.com/gpu- --overwrite
    exit 1
fi